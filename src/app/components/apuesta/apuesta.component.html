<div class="container mt-4" *ngIf="jornadaActiva; else noJornada">
  <!-- Cabecera: título + botones de sesión -->
  <div class="d-flex justify-content-between align-items-start mb-2">
    <div>
      <h2 class="mb-0">Apuestas - Jornada {{ jornadaActiva.numero }}</h2>
      <p class="partidos mt-1">Partidos: {{ jornadaActiva.partidos.join(' | ') }}</p>
    </div>

    <div class="d-flex gap-2">
      <!-- Botón de Iniciar Sesión para usuario normal -->
      <button *ngIf="!esAdmin" class="btn btn-primary btn-sm" (click)="irLogin()">Iniciar sesión (Admin)</button>

      <!-- Botones de administrador -->
      <button *ngIf="esAdmin" class="btn btn-outline-secondary btn-sm" (click)="irAdmin()">Ir a Admin</button>
      <button *ngIf="esAdmin" class="btn btn-danger btn-sm" (click)="resetearJornadas()">Resetear Jornadas</button>
      <button *ngIf="esAdmin" class="btn btn-warning btn-sm" (click)="cerrarSesion()">Cerrar Sesión</button>
    </div>
  </div>

  <!-- Fecha límite -->
  <p class="partidos text-center w-50" *ngIf="jornadaActiva.fechaLimite">
    Fecha límite para apostar: {{ jornadaActiva.fechaLimite | date:'dd/MM/yyyy HH:mm' }}
  </p>

  <p class="bote">Bote actual por participantes:
    <span class="fw-bold text-warning">€{{ jornadaActiva.bote.toFixed(2) }}</span>
  </p>
  <p class="bote m-2">Participantes: {{ jornadaActiva.apuestas.length || 0 }}/100</p>

  <ng-template #apuestasCerradas>
    <div class="alert alert-warning text-center mt-3">
      ⚠️ Apuestas cerradas. La fecha límite fue:
      <strong>{{ jornadaActiva.fechaLimite | date:'dd/MM/yyyy HH:mm' }}</strong>
    </div>
  </ng-template>

  <div *ngIf="jornadaAbierta; else apuestasCerradas">
    <!-- Formulario de apuestas -->
    <div class="card p-3 mt-3">
      <h5>Realiza tu apuesta</h5>

      <div class="mb-2">
        <label>Tu nombre</label>
        <input type="text" [(ngModel)]="apuesta.nombre" class="form-control"
               [ngClass]="{'is-invalid': !apuesta.nombre}" placeholder="Ej: Juan" required>
      </div>

      <div class="form-group mb-2">
        <label for="resultado1">Resultado 1</label>
        <input type="text" id="resultado1" class="form-control" [(ngModel)]="apuesta.resultado1"
               name="resultado1" maxlength="3" pattern="[0-9]-[0-9]" #res1="ngModel"
               [ngClass]="{ 'is-invalid': res1.invalid, 'is-valid': res1.valid }" required />
        <div class="invalid-feedback">Formato inválido. Usa Ej: 2-0</div>
      </div>

      <div class="form-group mb-2">
        <label for="resultado2">Resultado 2</label>
        <input type="text" id="resultado2" class="form-control" [(ngModel)]="apuesta.resultado2"
               name="resultado2" maxlength="3" pattern="[0-9]-[0-9]" #res2="ngModel" required
               [ngClass]="{ 'is-invalid': res2.invalid, 'is-valid': res2.valid }" />
        <div class="invalid-feedback">Formato inválido. Usa Ej: 1-1</div>
      </div>

      <div class="mb-2">
        <label>Resultado 3 (1/X/2)</label>
        <select [(ngModel)]="apuesta.resultado3" class="form-control"
                [ngClass]="{'is-invalid': !apuesta.resultado3}" required>
          <option value="">Selecciona</option>
          <option *ngFor="let op of opcionesResultado3" [value]="op">{{ op }}</option>
        </select>
      </div>

      <!-- PayPal -->
      <div id="paypal-button-container" class="mt-3"></div>

      <button class="btn btn-success mt-2" (click)="enviarApuesta()"
              [disabled]="!apuesta.nombre || !apuesta.resultado1 || !apuesta.resultado2 || !apuesta.resultado3">
        Enviar apuesta
      </button>
    </div>
  </div>

  <!-- Listado de apuestas -->
  <div class="row mt-4" *ngIf="apuestasPaginadas.length > 0">
    <h4 class="text-center">Apuestas realizadas</h4>

    <table class="table table-striped table-bordered mt-2">
      <thead class="table-dark text-warning">
        <tr>
          <th>Usuario</th>
          <th>Resultado 1</th>
          <th>Resultado 2</th>
          <th>Resultado 3</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let a of apuestasPaginadas">
          <td>{{ a.nombreUsuario || 'Administrador' }}</td>
          <td>{{ a.resultado1 }}</td>
          <td>{{ a.resultado2 }}</td>
          <td>{{ a.resultado3 }}</td>
          <td>{{ a.fecha | date:'dd/MM/yyyy HH:mm' }}</td>
        </tr>
      </tbody>
    </table>

    <!-- Paginación -->
    <div class="mt-3" *ngIf="jornadaActiva.apuestas.length > tamPagina">
      <button class="btn btn-sm btn-primary me-1" (click)="paginaAnterior()" [disabled]="paginaActual === 1">Anterior</button>
      <button class="btn btn-sm btn-primary" (click)="paginaSiguiente()" [disabled]="paginaActual >= totalPaginas">Siguiente</button>
      <span class="ms-2">Página {{ paginaActual }} / {{ totalPaginas }}</span>
    </div>
  </div>
</div>

<!-- ng-template para cuando NO hay jornada activa -->
<ng-template #noJornada>
  <div class="mt-4 text-center">
    <p class="text-danger">No hay ninguna jornada activa.</p>

    <!-- Crear jornada solo para admin -->
    <button *ngIf="esAdmin" class="btn btn-primary me-2" (click)="irAdmin()">Crear nueva jornada</button>

    <!-- Botón de login disponible siempre aquí -->
    <button class="btn btn-secondary" (click)="irLogin()">🔑 Ir a Login</button>
  </div>
</ng-template>
